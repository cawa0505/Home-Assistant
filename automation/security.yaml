        ##########################################################
        ## Household away - Master Security enabled. Security Doors Open
        ##########################################################

- alias: 'Security Doors - Open'
  initial_state: on
  trigger:
    - platform: state
      entity_id: groups.security_doors
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.alarm_safelist
      state: 'not_home'
    - condition: state
      entity_id: input_boolean.enable_security
      state: 'on'
    - condition: state
      entity_id: input_boolean.master_security
      state: 'on'

  action:
    - delay: '00:00:05'
    - condition: template
      value_template: "{{ is_state('input_boolean.enable_security', 'on') }}"

    - service: notify.telegram
      data:
        message: >
            No-one home - Alarm triggered - The following doors are open:
                {%- for entity_id in states.group.doors.attributes.entity_id -%}
                {% set parts = entity_id.split('.') -%}
                {%- if states(entity_id) == 'on' %}
                {%- if loop.first %} {% elif loop.last %} and the {% else %}, the {% endif -%}{{ states[parts[0]][parts[1]].name }}{% endif -%}
              {%- endfor %}

    - service: media_player.volume_set
      data_template:
        entity_id: group.google_home
        volume_level: 1

    - service: tts.google_say
      entity_id: group.google_home
      data:
        message: 'I want to play a game, you have 30 seconds to find and disable the alarm before some crazy shit happens'

    - delay: '00:00:35'

    - condition: template
      value_template: "{{ is_state('input_boolean.enable_security', 'on') }}"

    - service: media_player.volume_set
      data_template:
        entity_id: group.google_home
        volume_level: 1

    - service: tts.google_say
      entity_id: group.google_home
      data:
        message: 'Game over - Mug shot has been taken and the Police Has Been Notified!'
    - service: homeassistant.turn_on
      entity_id: input_boolean.alarm_tripped

    - service: light.turn_on
      entity_id:
        - light.hue_lights
      data:
        brightness_pct: 100
        color_name: "red"
        flash: long

    - service: light.turn_on
      entity_id:
        - light.hue_lights_exterior
      data:
        brightness_pct: 100
        flash: long

    - service: notify.telegram
      data:
        message: 'Alarm has sounded'


        ##########################################################
        ## Panic Mode
        ##########################################################

- alias: Security - Panic Mode
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.alarm_button
      to: 'on'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.panic_mode
    - service: notify.telegram
      data:
        message: 'PANIC BUTTON HAS BEEN PUSHED!'
    - service: light.turn_on
      entity_id:
        - light.hue_lights
      data:
       brightness_pct: 100
       color_name: "red"
    - service: light.turn_on
      entity_id:
        - light.hue_lights_exterior
      data:
       brightness_pct: 100
    - service: light.turn_on
      entity_id:
        - light.hue_lights
      data:
       flash: long
    - delay:
        seconds: 10
    - service: rest_command.reset_alarm_button
    - service: homeassistant.turn_off
      entity_id: input_boolean.panic_mode

        ##########################################################
        ## Shut Off Alarm Manually
        ##########################################################

- alias: Security - Shut Off Alarm Manually
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.alarm_button
      to: 'off'

  action:
     - service: notify.telegram
       data:
         message: 'Alarm has been disarmed manually'
     - service: homeassistant.turn_off
       entity_id: input_boolean.enable_security
     - service: homeassistant.turn_off
       entity_id: input_boolean.alarm_tripped
     - service: scene.turn_on
       entity_id: scene.disable_security

    # - service: wink.enable_siren
    #  data:
    #    entity_id: wink.siren
    #    enabled: 'false'

        ##########################################################
        ## Household away - Master Security disabled. Security Doors Open
        ##########################################################

- alias: 'Security Doors Open - Not Home'
  initial_state: on
  trigger:
    - platform: state
      entity_id: groups.security_doors
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.alarm_safelist
      state: 'not_home'
    - condition: state
      entity_id: input_boolean.master_security
      state: 'off'

  action:
    - service: notify.telegram
      data:
        message: >
            No-one home - Alarm triggered - The following doors are open:
                {%- for entity_id in states.group.doors.attributes.entity_id -%}
                {% set parts = entity_id.split('.') -%}
                {%- if states(entity_id) == 'on' %}
                {%- if loop.first %} {% elif loop.last %} and the {% else %}, the {% endif -%}{{ states[parts[0]][parts[1]].name }}{% endif -%}
              {%- endfor %}

        ##########################################################
        ## Panic Audio Notification
        ##########################################################

- alias: Notification Audio - Panic Audio

  trigger:
    - platform: state
      entity_id: input_boolean.panic_mode
      from: 'off'
      to: 'on'

  condition:

  action:
    - service: media_player.volume_set
      data_template:
        entity_id: group.google_home
        volume_level: 1
    - service: tts.google_say
      entity_id: group.google_home
      data:
        message: 'The rules of our game have been very clear. You need to abide by those rules.'
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.man_cave_home
        volume_level: 0.3

        ##########################################################
        ## Button Disable Alarm Audio Notification
        ##########################################################


- alias: Notification Audio - Disable Alarm Audio

  trigger:
    - platform: state
      entity_id: binary_sensor.alarm_button
      from: 'reset'
      to: 'off'

  condition:

  action:
    - service: tts.google_say
      entity_id: group.google_home
      data:
        message: 'Alarm has been disarmed!'
    - service: rest_command.reset_alarm_button

        ##########################################################
        ## Man Cave Door Audio Notification
        ##########################################################

- alias: 'Man Cave Door - Chris Not Home'
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.man_cave_door
      to: 'on'

  condition:
    - condition: state
      entity_id: group.person_chris
      state: 'not_home'

    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - delay: 00:00:15
    - condition: template
      value_template: "{{ is_state('input_boolean.enable_security', 'on') }}"

    - service: media_player.volume_set
      data_template:
        entity_id: media_player.man_cave_home
        volume_level: 0.5
    - service: tts.google_say
      entity_id: media_player.man_cave_home
      data:
        message: 'You are not the master, what are you doing here, smile at the camera, even better get naked!'
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.man_cave_home
        volume_level: 0.3

        ##########################################################
        ## Disarm Notification
        ##########################################################

- alias: 'Disarm Notification'
  initial_state: on
  trigger:
    - platform: state
      entity_id: input_boolean.enable_security
      from: 'on'
      to: 'off'

  condition:
    - condition: state
      entity_id: input_boolean.master_security
      state: 'on'

  action:
    - wait_template: "{{ states.binary_sensor.porch_door.state == 'on' }}"
      timeout: 00:03:00
    - service: media_player.volume_set
      data_template:
        entity_id: group.google_home
        volume_level: 0.3

    - service: tts.google_say
      entity_id: group.google_home
      data:
        message: 'Alarm has been disarmed'

        ##########################################################
        ## Disable Alarm Audio Notification
        ##########################################################


- alias: Notification Audio - Disable Alarm Audio Button

  trigger:
    - platform: state
      entity_id: binary_sensor.alarm_button
      from: 'reset'
      to: 'off'

  condition:

  action:
    - service: tts.google_say
      entity_id: group.google_home
      data:
        message: 'Alarm has been disarmed!'
    - service: rest_command.reset_alarm_button
