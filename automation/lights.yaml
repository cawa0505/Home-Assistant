#################################################################
## Lights Automations
#################################################################

    - alias: 'Man Cave Button Presed - on'
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.man_cave_button
        from: 'off'
        to: 'on'

      action:
        - service: light.turn_on
          entity_id:
            - light.man_cave_lamp
            - light.man_cave_desk_strip
        - service: switch.turn_on
          entity_id:
             - switch.man_cave_console_lights

    - alias: 'Man Cave Button Pressed - off'
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.man_cave_button
        from: 'on'
        to: 'off'

      action:
        - service: light.turn_off
          entity_id:
            - light.man_cave_lamp
            - light.man_cave_desk_strip
        - service: switch.turn_off
          entity_id:
             - switch.man_cave_console_lights

        ##########################################################
        ## Porch Door - Open
        ##########################################################

    - alias: Porch Door - Open
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.porch_door
        from: 'off'
        to: 'on'

      action:
        - service: light.turn_on
          entity_id:
             - light.porch

 
        ##########################################################
        ## Porch Door - Open & Sunset
        ##########################################################

    - alias: Porch Door - Open & Sunset
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.porch_door
        from: 'off'
        to: 'on'

      condition:
        condition: state
        entity_id: sun.sun
        state: below_horizon

      action:
        - service: light.turn_on
          entity_id:
             - light.porch
             - light.outside       

        #########################################################
        ## Man Cave Door - Open & Sunset
        ##########################################################

    - alias: Man Cave Door - Open & Sunset
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.man_cave_door
        from: 'off'
        to: 'on'

      action:
        - service: light.turn_on
          entity_id:
             - light.man_cave_desk_strip
        - service: switch.turn_on
          entity_id:
             - switch.man_cave_console_lights             

        #########################################################
        ## Man Cave Door - Open & Sunset
        ##########################################################

    - alias: Man Cave Door - Open & Sunset
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.man_cave_door
        from: 'off'
        to: 'on'

      condition:
        condition: state
        entity_id: sun.sun
        state: below_horizon

      action:
        - service: light.turn_on
          entity_id:
             - light.man_cave_desk_strip
             - light.man_cave_lamp
        - service: switch.turn_on
          entity_id:
             - switch.man_cave_console_lights

        ##########################################################
        ## Man Cave Door closed and no motion - Turn off lights
        ##########################################################

    - alias: 'Man Cave Door Closed, no motion - Turn off lights'
      initial_state: on
      trigger:
        - platform: state
          entity_id: binary_sensor.man_cave_door
          to: 'off'
          for: '00:03:00'

      action:
        - service: light.turn_off
          entity_id:
            - group.man_cave_lights
        - service: switch.turn_off
          entity_id:
             - switch.man_cave_console_lights

        #########################################################
        ## Man Cave Door - Closed - Turn on landing light
        #########################################################

    - alias: Man Cave Door - Closed - Turn on landing light
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.man_cave_door
        from: 'on'
        to: 'off'

      condition:
        - condition: state
          entity_id: sun.sun
          state: below_horizon

      action:
        - service: light.turn_on
          entity_id: light.man_cave_landing
          data_template:
            brightness: >
              {% if now().hour > 20 %}64
              {% else %}100
              {% endif %}

        ##########################################################
        ## Front Door - Open
        ##########################################################

    - alias: Front Door - Open
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.front_door_2
        from: 'off'
        to: 'on'

      action:
        - service: light.turn_on
          entity_id:
             - light.porch


        ##########################################################
        ## Front Door - Open & Sunset
        ##########################################################

    - alias: Front Door - Open & Sunset
      initial_state: on
      trigger:
        platform: state
        entity_id: binary_sensor.front_door_2
        from: 'off'
        to: 'on'

      condition:
        condition: state
        entity_id: sun.sun
        state: below_horizon

      action:
        - service: light.turn_on
          entity_id:
             - light.porch
             - light.outside


        ##########################################################
        ## Upstairs motion - Turn on Man Cave Landing
        ##########################################################

    - alias: 'Upstairs motion - Turn on Man Cave Landing'
      initial_state: on
      trigger:
        - platform: state
          entity_id: sensor.upstairs_motion_sensor
          to: 'on'

      condition:
        condition: and
        conditions:

          - condition: state
            entity_id: sun.sun
            state: below_horizon

          - condition: state
            entity_id: light.upstairs_hallway
            state: 'on'

      action:
        - service: light.turn_on
          entity_id: light.man_cave_landing
          data_template:
            brightness: '{% if now().hour > 20 %}64{% else %}100{% endif %}'

        ##########################################################
        ## Upstairs motion - Turn off Man Cave Landing
        ##########################################################

    - alias: 'Upstairs motion - Turn off Man Cave Landing'
      initial_state: on
      trigger:
        - platform: state
          entity_id: sensor.upstairs_motion_sensor
          to: 'off'
          for: '00:03:00'

      action:
        - service: light.turn_off
          entity_id:
            - light.man_cave_landing

        ##########################################################
        ## No-one home - lights on
        ##########################################################

    - alias: 'No One Home - Lights on'
      initial_state: on
      trigger:
        platform: state
        from: 'off'
        to: 'on'
        entity_id: group.all_lights

      action:
        - delay: 00:02:00
        - condition: template
          value_template: "{{ is_state('group.household.state', 'not_home') }}"
        - service: notify.telegram
          data_template:
            message: >
              The following lights are on:
              {%- for entity_id in states.group.all_lights.attributes.entity_id -%}
                {% set parts = entity_id.split('.') -%}
                {%- if states(entity_id) == 'on' %}
                {%- if loop.first %} {% elif loop.last %} and the {% else %}, the {% endif -%}{{ states[parts[0]][parts[1]].name }}{% endif -%}
              {%- endfor %}

        ##########################################################
        ## No-one home - Hue lights on
        ##########################################################

    - alias: 'No One Home - Hue Lights on'
      initial_state: on
      trigger:
        platform: state
        from: 'off'
        to: 'on'
        entity_id: light.hue_lights

      action:
        - delay: 00:02:00
        - condition: template
          value_template: "{{ is_state('group.household.state', 'not_home') }}"
        - service: notify.telegram
          data_template:
            message: >
              The following lights are on:
              {%- for entity_id in states.light.hue_lights.attributes.entity_id -%}
                {% set parts = entity_id.split('.') -%}
                {%- if states(entity_id) == 'on' %}
                {%- if loop.first %} {% elif loop.last %} and the {% else %}, the {% endif -%}{{ states[parts[0]][parts[1]].name }}{% endif -%}
              {%- endfor %}

        ##########################################################
        ## Turn on outside light at sunset
        ##########################################################

    - alias: 'Turn on outside light between sunset +1'
      initial_state: on
      trigger:
        platform: sun
        event: sunset
        offset: '+01:00:00'

      condition:
        condition: state
        entity_id: input_boolean.disable_light_automations
        state: 'off'        

      action:
       - service: light.turn_on
         entity_id:
           - light.outside

        ##########################################################
        ## Turn off outside light at 00:00
        ##########################################################

    - alias: 'Turn off outside light at 00:00'
      initial_state: on
      trigger:
        platform: time
        at: '00:00:00'

      condition:
        condition: state
        entity_id: input_boolean.disable_light_automations
        state: 'off'

      action:
       - service: light.turn_off
         entity_id:
           - light.outside

        ##########################################################
        ## Turn off Hallway Lamp at 23:00
        ##########################################################

    - alias: 'Turn off Hallway Lamp at 23:00'
      initial_state: on
      trigger:
        platform: time
        at: '23:00:00'

      condition:
        condition: state
        entity_id: input_boolean.disable_light_automations
        state: 'off'

      action:
       - service: homeassistant.turn_off
         entity_id: switch.hallway_lamp

        ##########################################################
        ## Turn off Hallway Lamp at 23:00
        ##########################################################

    - alias: 'Turn on Hallway Lamp at sunset'
      initial_state: on
      trigger:
        platform: sun
        event: sunset
        offset: "+01:00:00"

      condition:
        - condition: state
          entity_id: input_boolean.master_security
          state: 'on'

        - condition: state
          entity_id: input_boolean.disable_light_automations
          state: 'off'       

      action:
       - service: homeassistant.turn_on
         entity_id: switch.hallway_lamp

        ##########################################################
        ## Exterior_Doors closed for 10 mins
        ##########################################################

    - alias: Exterior Doors Closed for 10 mins
      trigger:
        platform: state
        entity_id: group.exterior_doors
        from: 'on'
        to: 'off'
        for:
          minutes: 10

      condition:
        condition: state
        entity_id: input_boolean.disable_light_automations
        state: 'off'

      action:
        service: light.turn_off
        entity_id:
             - light.porch
             - light.outside